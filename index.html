<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>馬賽數位觀課儀表板 V1.4</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e2e',
                            950: '#020617', // Deep background
                        },
                        amber: {
                            350: '#E0C068', // Light Gold
                            450: '#D4AF37', // Klimt Gold
                            550: '#B8860B', // Dark Goldenrod
                        },
                        rust: {
                            500: '#B7410E', // Rust
                            600: '#9A3309',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 12s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #D4AF37' },
                            '100%': { boxShadow: '0 0 20px #D4AF37, 0 0 10px #B7410E' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #fffbeb; /* amber-50 */
            overflow: hidden; /* App-like feel */
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-header {
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* Scrollbar styling for Log Stream */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(2, 6, 23, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.6);
        }

        /* Klimt Pattern Overlay (CSS only geometric) */
        .klimt-pattern {
            background-image: radial-gradient(circle at 2px 2px, rgba(212, 175, 55, 0.15) 1px, transparent 0);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Constants & Config ---
        const APP_VERSION = "V1.4";
        const SUBJECTS = ["國語文", "英語文", "數學", "社會", "自然", "綜合", "本土語", "藝文", "資訊"];
        
        const MODES_CONFIG = [
            { id: 'lecture', label: '講述教學' },
            { id: 'discuss', label: '小組討論' },
            { id: 'practice', label: '實作/演算' },
            { id: 'digital', label: '數位運用' }
        ];

        const ACTIONS_CONFIG = [
            { id: 'encourage', label: '正向鼓勵', color: 'text-amber-400' },
            { id: 'correct', label: '糾正規範', color: 'text-rust-500' },
            { id: 'openQ', label: '開放提問', color: 'text-blue-400' },
            { id: 'closeQ', label: '封閉提問', color: 'text-purple-400' },
            { id: 'walk', label: '巡視走動', color: 'text-green-400' }
        ];

        const QUICK_COMMENTS = [
            "學生向老師提問", 
            "同學間互助解決問題", 
            "課堂氣氛", 
            "學生參與度和回答內容"
        ];

        // --- Helper Components ---

        // Klimt Style Start Button
        const StartButton = ({ onClick, disabled }) => (
            <button 
                onClick={onClick}
                disabled={disabled}
                className={`relative w-16 h-16 group transition-all duration-300 ${disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'hover:scale-110 cursor-pointer'}`}
                title="開始觀課"
            >
                <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_10px_rgba(212,175,55,0.5)]">
                    <defs>
                        <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#E0C068" />
                            <stop offset="50%" stopColor="#D4AF37" />
                            <stop offset="100%" stopColor="#B8860B" />
                        </linearGradient>
                    </defs>
                    {/* Rotating Dashed Circle */}
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#goldGrad)" strokeWidth="2" strokeDasharray="10 5" className={!disabled ? "animate-spin-slow" : ""} />
                    <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(255,255,255,0.2)" strokeWidth="1" />
                    
                    {/* Center Play Triangle */}
                    <path d="M 40 30 L 70 50 L 40 70 Z" fill="url(#goldGrad)" className="transition-all group-hover:brightness-125" />
                    
                    {/* Decor */}
                    <rect x="48" y="10" width="4" height="4" fill="#B7410E" transform="rotate(45 50 12)" />
                </svg>
            </button>
        );

        // Klimt Style Stop Button
        const StopButton = ({ onClick, disabled }) => (
            <button 
                onClick={onClick}
                disabled={disabled}
                className={`relative w-16 h-16 group transition-all duration-300 ${disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'hover:scale-110 cursor-pointer'}`}
                title="停止/暫停"
            >
                <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_10px_rgba(183,65,14,0.5)]">
                    <defs>
                        <linearGradient id="rustGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#D97706" />
                            <stop offset="100%" stopColor="#B7410E" />
                        </linearGradient>
                    </defs>
                    {/* Outer Geometric Shape */}
                    <rect x="15" y="15" width="70" height="70" rx="10" fill="none" stroke="url(#rustGrad)" strokeWidth="3" />
                    <rect x="20" y="20" width="60" height="60" rx="5" fill="rgba(183,65,14,0.1)" />
                    
                    {/* Center Stop Square */}
                    <rect x="32" y="32" width="36" height="36" rx="4" fill="url(#rustGrad)" className="transition-all group-hover:brightness-125" />
                    
                    {/* Decor */}
                    <circle cx="20" cy="20" r="3" fill="#D4AF37" />
                    <circle cx="80" cy="80" r="3" fill="#D4AF37" />
                </svg>
            </button>
        );

        // --- Custom Hook for LocalStorage ---
        function useStickyState(defaultValue, key) {
            const [value, setValue] = React.useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            React.useEffect(() => {
                // CRITICAL FIX: If global reset flag is set, DO NOT save anything.
                // This prevents race conditions where React state updates (e.g. from timers) 
                // overwrite the cleared localStorage before reload completes.
                if (window.__isResetting) return; 
                
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        }

        // --- Main App Component ---
        const App = () => {
            // -- State (Persistent) --
            const [isActive, setIsActive] = useStickyState(false, 'maasai_active');
            const [selectedSubject, setSelectedSubject] = useStickyState(SUBJECTS[0], 'maasai_subject');
            const [startTime, setStartTime] = useStickyState(null, 'maasai_startTime');
            
            // Log Data (Persistent)
            const [logs, setLogs] = useStickyState([], 'maasai_logs');
            
            // Mode State (Persistent)
            const [modeStates, setModeStates] = useStickyState(
                MODES_CONFIG.reduce((acc, mode) => ({ ...acc, [mode.id]: { active: false, duration: 0 } }), {}),
                'maasai_modeStates'
            );

            // Action Counts (Persistent)
            const [actionCounts, setActionCounts] = useStickyState(
                ACTIONS_CONFIG.reduce((acc, action) => ({ ...acc, [action.id]: 0 }), {}),
                'maasai_actionCounts'
            );

            // Engagement (Persistent)
            const [engagement, setEngagement] = useStickyState('mid', 'maasai_engagement');
            
            // -- State (Transient/UI) --
            const [currentTime, setCurrentTime] = useState(new Date());
            const [lastInteraction, setLastInteraction] = useState(Date.now());
            const [showEngagementAlert, setShowEngagementAlert] = useState(false);
            const [qualitativeText, setQualitativeText] = useState("");
            const [showReport, setShowReport] = useState(false);
            // NEW: Store the generated report to display after data reset
            const [frozenReport, setFrozenReport] = useState("");

            // Refs for scrolling
            const logEndRef = useRef(null);

            // -- Effects --

            // System Clock
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Mode Timer Logic
            useEffect(() => {
                let interval;
                if (isActive) {
                    interval = setInterval(() => {
                        setModeStates(prev => {
                            const next = { ...prev };
                            let hasChanges = false;
                            Object.keys(next).forEach(key => {
                                if (next[key].active) {
                                    next[key] = { ...next[key], duration: next[key].duration + 1 };
                                    hasChanges = true;
                                }
                            });
                            return hasChanges ? next : prev;
                        });
                        
                        // Engagement Alert Check (5 minutes = 300000ms)
                        if (Date.now() - lastInteraction > 300000) {
                            setShowEngagementAlert(true);
                        }

                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isActive, lastInteraction, setModeStates]); // Added setModeStates dependency

            // Auto-scroll logs
            useEffect(() => {
                if (logEndRef.current) {
                    logEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [logs]);

            // -- Handlers --

            const handleStartStop = () => {
                const now = new Date();
                setLastInteraction(Date.now());
                setShowEngagementAlert(false);

                if (!isActive) {
                    // Start
                    setIsActive(true);
                    if (!startTime) setStartTime(now);
                    addLog('system', '開始觀課', `科目: ${selectedSubject}`);
                } else {
                    // STOP & AUTO-RESET LOGIC
                    
                    // 1. Generate Report based on CURRENT data immediately
                    const finalReportStr = generateReport();
                    setFrozenReport(finalReportStr);
                    setShowReport(true);

                    // 2. Perform "Soft Reset" immediately after stopping
                    // This clears the dashboard for the next session
                    setIsActive(false);
                    setStartTime(null);
                    setLogs([]);
                    
                    // Reset all counters to defaults
                    setModeStates(MODES_CONFIG.reduce((acc, mode) => ({ ...acc, [mode.id]: { active: false, duration: 0 } }), {}));
                    setActionCounts(ACTIONS_CONFIG.reduce((acc, action) => ({ ...acc, [action.id]: 0 }), {}));
                    setEngagement('mid');
                }
            };

            const handleManualReset = () => {
                if(confirm("確定要強制清除並重新載入頁面？")) {
                    window.__isResetting = true;
                    const keysToRemove = [
                        'maasai_active', 'maasai_subject', 'maasai_startTime', 
                        'maasai_logs', 'maasai_modeStates', 'maasai_actionCounts', 'maasai_engagement'
                    ];
                    keysToRemove.forEach(k => window.localStorage.removeItem(k));
                    setTimeout(() => window.location.reload(), 50);
                }
            };

            const toggleMode = (modeId) => {
                if (!isActive) return; // Prevent interaction if not started
                
                setLastInteraction(Date.now());
                setShowEngagementAlert(false);

                setModeStates(prev => {
                    const isNowActive = !prev[modeId].active;
                    addLog('mode', isNowActive ? '模式啟動' : '模式結束', MODES_CONFIG.find(m => m.id === modeId).label);
                    return {
                        ...prev,
                        [modeId]: { ...prev[modeId], active: isNowActive }
                    };
                });
            };

            const recordAction = (actionId) => {
                if (!isActive) return;
                
                setLastInteraction(Date.now());
                setShowEngagementAlert(false);

                setActionCounts(prev => ({ ...prev, [actionId]: prev[actionId] + 1 }));
                const actionDef = ACTIONS_CONFIG.find(a => a.id === actionId);
                addLog('action', actionDef.label, '計次 +1');
            };

            const addLog = (type, label, detail) => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
                setLogs(prev => [...prev, { id: Date.now(), time: timeStr, type, label, detail }]);
            };

            const handleEngagementChange = (level) => {
                setEngagement(level);
                setLastInteraction(Date.now());
                setShowEngagementAlert(false);
                
                const labelMap = { 'high': '高', 'mid': '中', 'low': '低' };
                addLog('engagement', '專注度紀錄', labelMap[level]);
            };

            const handleQuickComment = (text) => {
                setQualitativeText(prev => (prev ? prev + "，" : "") + text);
            };

            const submitTextLog = () => {
                if (!qualitativeText.trim()) return;
                addLog('note', '質性紀錄', qualitativeText);
                setQualitativeText("");
                setLastInteraction(Date.now());
                setShowEngagementAlert(false);
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            // -- Export Logic / Analysis --
            
            const generateIndicatorText = () => {
                const combinedLogs = logs.map(l => l.detail).join(" ");
                const hasTerm = (term) => combinedLogs.includes(term);
                
                const facts = [];
                // [Analysis Logic]
                
                // A-2-1
                if (actionCounts.encourage > 0 || hasTerm("動機") || hasTerm("生活")) {
                    facts.push("A-2-1: 運用鼓勵或連結生活經驗，引發學習動機。");
                } else if (modeStates.lecture.duration > 30) {
                     facts.push("A-2-1: 課程開始進行說明，嘗試引起注意。");
                } else {
                    facts.push("A-2-1: 未觀察到");
                }

                // A-2-2
                if (modeStates.digital.duration > 60) {
                    facts.push("A-2-2: 運用數位工具清晰呈現教材與概念。");
                } else if (modeStates.lecture.duration > 60) {
                    facts.push("A-2-2: 口語說明清晰，協助學生掌握重點。");
                } else {
                    facts.push("A-2-2: 未觀察到");
                }

                // A-2-3
                if (modeStates.practice.duration > 60) {
                    facts.push("A-2-3: 安排實作練習，協助學生熟練內容。");
                } else if (modeStates.discuss.duration > 60) {
                    facts.push("A-2-3: 透過討論活動，加深對內容的理解。");
                } else {
                    facts.push("A-2-3: 未觀察到");
                }

                // A-2-4
                if (hasTerm("總結") || hasTerm("歸納")) {
                    facts.push("A-2-4: 活動後適時歸納，統整學習重點。");
                } else {
                    facts.push("A-2-4: 未觀察到 (或未記錄到歸納環節)");
                }

                // A-3-1
                if (modeStates.discuss.duration > 0 || actionCounts.openQ > 0) {
                    facts.push("A-3-1: 運用提問或討論策略，引導思考實作。");
                } else {
                    facts.push("A-3-1: 未觀察到");
                }

                // A-3-2
                if (modeStates.practice.duration > 0 && actionCounts.walk > 0) {
                    facts.push("A-3-2: 在活動中指導學習策略與方法。");
                } else {
                    facts.push("A-3-2: 未觀察到");
                }

                // A-3-3
                if (actionCounts.walk > 0 || (actionCounts.openQ + actionCounts.closeQ) > 0) {
                    facts.push("A-3-3: 運用巡視與口語溝通技巧幫助學習。");
                } else {
                    facts.push("A-3-3: 未觀察到");
                }

                // A-4-1
                if (actionCounts.closeQ > 0 || modeStates.practice.duration > 0) {
                    facts.push("A-4-1: 運用提問或實作觀察評估學習成效。");
                } else {
                    facts.push("A-4-1: 未觀察到");
                }

                // A-4-2
                if (actionCounts.correct > 0 || actionCounts.encourage > 0) {
                    facts.push("A-4-2: 依據學生表現提供適切回饋與指導。");
                } else {
                    facts.push("A-4-2: 未觀察到");
                }

                // A-4-3
                if (actionCounts.walk > 2 && actionCounts.correct > 0) {
                    facts.push("A-4-3: 根據巡視結果即時調整指導內容。");
                } else {
                    facts.push("A-4-3: 未觀察到");
                }

                // B-1-1
                if (actionCounts.correct > 0 || hasTerm("常規") || hasTerm("秩序")) {
                    facts.push("B-1-1: 建立並維持有助學習的課堂規範。");
                } else {
                    facts.push("B-1-1: 未觀察到");
                }

                // B-1-2
                if (actionCounts.encourage > 0) {
                    facts.push("B-1-2: 給予正向鼓勵，引導良好行為表現。");
                } else {
                    facts.push("B-1-2: 未觀察到");
                }

                // B-2-1
                if (actionCounts.walk > 0) {
                    facts.push("B-2-1: 善用教學空間，巡視動線流暢。");
                } else {
                    facts.push("B-2-1: 未觀察到");
                }

                // B-2-2
                if (actionCounts.encourage > 2 || modeStates.discuss.duration > 0) {
                    facts.push("B-2-2: 營造溫暖氣氛，促進師生合作互動。");
                } else {
                    facts.push("B-2-2: 未觀察到");
                }
                
                return facts.join("\n");
            };

            const generateReport = () => {
                let report = `馬賽數位觀課儀表板 ${APP_VERSION} - 觀課紀錄\n`;
                report += `日期: ${new Date().toLocaleDateString()}\n`;
                report += `科目: ${selectedSubject}\n`;
                const startStr = startTime ? new Date(startTime).toLocaleTimeString() : '-';
                report += `總時間: ${startStr} - ${new Date().toLocaleTimeString()}\n\n`;
                
                report += `[教學模式統計]\n`;
                MODES_CONFIG.forEach(m => {
                    report += `${m.label}: ${formatTime(modeStates[m.id].duration)}\n`;
                });
                
                report += `\n[教學行為統計]\n`;
                ACTIONS_CONFIG.forEach(a => {
                    report += `${a.label}: ${actionCounts[a.id]} 次\n`;
                });

                report += `\n[指標檢核與事實摘要] (依據數據自動生成)\n`;
                report += generateIndicatorText();

                report += `\n\n[詳細紀錄流]\n`;
                logs.forEach(l => {
                    report += `[${l.time}] ${l.type.toUpperCase()} - ${l.label}: ${l.detail}\n`;
                });

                return report;
            };

            const copyToClipboard = () => {
                // Use the frozen report instead of regenerating from empty state
                const text = frozenReport;
                
                const legacyCopy = (text) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    textArea.setAttribute('readonly', '');
                    
                    document.body.appendChild(textArea);
                    
                    const range = document.createRange();
                    range.selectNodeContents(textArea);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    textArea.setSelectionRange(0, 999999);
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) alert("已複製到剪貼簿");
                        else alert("複製失敗，請手動選取文字");
                    } catch (err) {
                        alert("複製失敗，請手動選取文字");
                    }
                    
                    document.body.removeChild(textArea);
                };

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert("已複製到剪貼簿"))
                        .catch(err => {
                            legacyCopy(text);
                        });
                } else {
                    legacyCopy(text);
                }
            };

            const downloadTxt = () => {
                const text = frozenReport;
                const blob = new Blob(["\ufeff" + text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `觀課紀錄_${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // --- Render ---
            return (
                <div className="flex flex-col h-screen w-full bg-slate-950 text-slate-200 klimt-pattern overflow-hidden">
                    
                    {/* --- HEADER --- */}
                    <header className="flex-none h-16 glass-header flex items-center justify-between px-4 z-20">
                        <div className="flex items-center gap-4">
                            <div className="text-amber-400 font-bold text-lg tracking-widest border border-amber-500/30 px-2 py-1">
                                馬賽數位觀課儀表板 <span className="text-xs align-top opacity-70">{APP_VERSION}</span>
                            </div>
                            <select 
                                className="bg-slate-900 border border-slate-700 text-amber-50 rounded px-2 py-1 focus:ring-1 focus:ring-amber-500 outline-none"
                                value={selectedSubject}
                                onChange={(e) => setSelectedSubject(e.target.value)}
                                disabled={isActive}
                            >
                                {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>

                        <div className="text-2xl font-mono text-amber-100 font-light tracking-widest drop-shadow-[0_0_5px_rgba(212,175,55,0.3)]">
                            {currentTime.toLocaleTimeString('zh-TW', { hour12: false })}
                        </div>

                        <div className="flex items-center">
                            {isActive ? (
                                <StopButton onClick={handleStartStop} />
                            ) : (
                                <StartButton onClick={handleStartStop} />
                            )}
                        </div>
                    </header>

                    {/* --- MAIN LAYOUT (Grid) --- */}
                    <main className="flex-1 grid grid-cols-1 md:grid-cols-[1fr_1fr_320px] overflow-hidden relative">
                        
                        {/* LEFT: Teaching Modes */}
                        <section className="p-4 flex flex-col gap-4 overflow-y-auto border-r border-slate-800/50 bg-slate-900/20">
                            <h2 className="text-amber-500/80 text-sm font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                                <span className="w-2 h-2 bg-amber-500 rotate-45"></span>
                                教學模式 (多選計時)
                            </h2>
                            <div className="grid grid-cols-2 gap-2 md:gap-3 h-full content-start">
                                {MODES_CONFIG.map(mode => {
                                    const state = modeStates[mode.id];
                                    return (
                                        <button
                                            key={mode.id}
                                            onClick={() => toggleMode(mode.id)}
                                            // Brightness logic: If not active session, still full opacity (per request), but cursor distinct
                                            disabled={!isActive}
                                            className={`
                                                relative flex flex-row md:flex-col items-center justify-between md:justify-center 
                                                p-3 md:p-4 rounded-sm border transition-all duration-200 
                                                h-16 md:h-auto md:aspect-[4/3]
                                                ${!isActive 
                                                    ? 'opacity-100 border-slate-700 bg-slate-800/40 text-slate-400 cursor-not-allowed' // "Increased brightness" interpretation: Visible but standard disabled look
                                                    : state.active 
                                                        ? 'bg-amber-600/20 border-amber-500 text-amber-50 shadow-[0_0_15px_rgba(212,175,55,0.2)]' 
                                                        : 'bg-slate-800/40 border-slate-700 text-slate-300 hover:border-amber-500/50 hover:bg-slate-800/60'
                                                }
                                            `}
                                        >
                                            <span className="text-base md:text-lg font-medium tracking-wide mb-0 md:mb-2">{mode.label}</span>
                                            <span className={`text-xl md:text-2xl font-mono ${state.active ? 'text-amber-400' : 'text-slate-500'}`}>
                                                {formatTime(state.duration)}
                                            </span>
                                            {state.active && (
                                                <div className="absolute top-1 right-1 w-2 h-2 bg-amber-400 rounded-full animate-pulse"></div>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </section>

                        {/* CENTER: Teaching Actions */}
                        <section className="p-4 flex flex-col gap-4 overflow-y-auto border-r border-slate-800/50 bg-slate-900/20">
                            <h2 className="text-rust-500/80 text-sm font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                                <span className="w-2 h-2 bg-rust-500 rotate-45"></span>
                                教學行為 (計次)
                            </h2>
                            <div className="grid grid-cols-2 gap-2 md:gap-3 h-full content-start">
                                {ACTIONS_CONFIG.map(action => (
                                    <button
                                        key={action.id}
                                        onClick={() => recordAction(action.id)}
                                        disabled={!isActive}
                                        className={`
                                            flex flex-row md:flex-col items-center justify-between md:justify-center 
                                            p-3 md:p-4 rounded-sm border transition-all duration-100 
                                            h-16 md:h-auto md:aspect-[4/3] active:scale-95
                                            ${!isActive 
                                                ? 'opacity-100 border-slate-700 bg-slate-800/40 text-slate-400 cursor-not-allowed' 
                                                : 'bg-slate-800/60 border-slate-600 hover:bg-slate-700 hover:border-slate-500 text-slate-200'
                                            }
                                        `}
                                    >
                                        <span className={`text-base md:text-lg font-medium mb-0 md:mb-1 ${!isActive ? 'text-slate-500' : action.color}`}>{action.label}</span>
                                        <span className="text-xl md:text-3xl font-bold font-mono text-slate-100">
                                            {actionCounts[action.id]}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* RIGHT: Log Stream (Hidden on Mobile) */}
                        <aside className="hidden md:flex bg-slate-950/80 border-l border-slate-800 flex-col h-full md:relative md:w-auto z-10 glass-panel">
                             <h2 className="p-3 text-slate-400 text-xs font-bold uppercase tracking-widest border-b border-slate-800 flex justify-between items-center">
                                即時紀錄流
                                <span className="px-1.5 py-0.5 bg-slate-800 rounded text-[10px]">{logs.length}</span>
                            </h2>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 font-mono text-sm">
                                {logs.length === 0 && (
                                    <div className="text-slate-600 text-center mt-10 italic">尚未有紀錄...</div>
                                )}
                                {logs.map((log) => (
                                    <div key={log.id} className="flex gap-2 p-2 rounded bg-slate-900/50 border border-slate-800/50 hover:border-amber-500/20 transition-colors">
                                        <span className="text-slate-500 text-xs whitespace-nowrap">{log.time}</span>
                                        <div className="flex flex-col min-w-0">
                                            <span className={`text-xs font-bold uppercase tracking-wider
                                                ${log.type === 'system' ? 'text-slate-400' : 
                                                  log.type === 'mode' ? 'text-amber-500' : 
                                                  log.type === 'action' ? 'text-rust-500' : 
                                                  log.type === 'engagement' ? 'text-purple-400' : 'text-blue-400'}
                                            `}>
                                                {log.label}
                                            </span>
                                            <span className="text-slate-300 truncate">{log.detail}</span>
                                        </div>
                                    </div>
                                ))}
                                <div ref={logEndRef} />
                            </div>
                        </aside>

                    </main>

                    {/* --- FOOTER (Sticky) --- */}
                    <footer className={`
                        flex-none glass-panel border-t border-slate-700/50 p-2 z-30 transition-colors duration-500
                        ${showEngagementAlert ? 'animate-pulse-fast bg-rust-900/40 border-rust-500' : ''}
                    `}>
                        <div className="max-w-7xl mx-auto flex flex-col gap-2">
                            
                            {/* Top Row: Engagement & Send - CHANGED LAYOUT */}
                            <div className="flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-4">
                                {/* Engagement Slider - Centered on mobile or full width */}
                                <div className="flex items-center justify-between md:justify-start gap-2 bg-slate-900/80 p-1.5 rounded-full border border-slate-700">
                                    <span className="text-xs text-slate-400 px-2 font-bold">專注度</span>
                                    {['high', 'mid', 'low'].map((level) => {
                                        const colors = {
                                            high: 'bg-green-600 hover:bg-green-500',
                                            mid: 'bg-yellow-600 hover:bg-yellow-500',
                                            low: 'bg-red-600 hover:bg-red-500'
                                        };
                                        const active = engagement === level;
                                        return (
                                            <button
                                                key={level}
                                                onClick={() => handleEngagementChange(level)}
                                                disabled={!isActive}
                                                className={`
                                                    w-8 h-8 rounded-full flex items-center justify-center transition-all
                                                    ${active ? colors[level] + ' ring-2 ring-white scale-110' : 'bg-slate-700 opacity-40 hover:opacity-80'}
                                                    ${!isActive ? 'cursor-not-allowed opacity-30' : ''}
                                                `}
                                                title={level === 'high' ? '高' : level === 'mid' ? '中' : '低'}
                                            >
                                                {level === 'high' && 'High'}
                                                {level === 'mid' && 'Mid'}
                                                {level === 'low' && 'Low'}
                                                {/* Use simple geometric indicators if text is too small */}
                                                <div className={`w-3 h-3 rounded-full bg-white/90 shadow-sm`}></div>
                                            </button>
                                        )
                                    })}
                                </div>

                                {/* Input Area */}
                                <div className="flex-1 flex gap-2">
                                    <input
                                        type="text"
                                        value={qualitativeText}
                                        onChange={(e) => setQualitativeText(e.target.value)}
                                        placeholder="輸入質性觀察紀錄..."
                                        className="flex-1 bg-slate-800/50 border border-slate-600 text-slate-100 rounded px-3 focus:outline-none focus:border-amber-500 transition-colors min-w-0"
                                        disabled={!isActive}
                                    />
                                    <button 
                                        onClick={submitTextLog}
                                        disabled={!isActive}
                                        className="bg-slate-700 hover:bg-amber-600 text-white px-4 py-1 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                                    >
                                        發送
                                    </button>
                                </div>
                            </div>

                            {/* Bottom Row: Quick Tags */}
                            <div className="flex gap-2 overflow-x-auto pb-1">
                                {QUICK_COMMENTS.map((tag, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => handleQuickComment(tag)}
                                        disabled={!isActive}
                                        className="whitespace-nowrap px-3 py-1 text-xs bg-slate-800 border border-slate-600 rounded-full text-slate-300 hover:border-amber-500 hover:text-amber-400 transition-colors disabled:opacity-50"
                                    >
                                        {tag}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </footer>

                    {/* --- REPORT MODAL --- */}
                    {showReport && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm p-4">
                            <div className="bg-slate-900 border border-amber-500/30 rounded-lg shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-lg">
                                    <h3 className="text-xl font-bold text-amber-500">觀課總結</h3>
                                    <button onClick={() => setShowReport(false)} className="text-slate-400 hover:text-white">✕</button>
                                </div>
                                <div className="p-6 overflow-y-auto font-mono text-sm text-slate-300 bg-slate-950/50 m-4 rounded border border-slate-800 whitespace-pre-wrap">
                                    {frozenReport /* Show the frozen report, as the live data is already reset */}
                                </div>
                                <div className="p-4 border-t border-slate-700 bg-slate-800/30 rounded-b-lg flex justify-between items-center gap-4">
                                     <button 
                                        onClick={handleManualReset}
                                        className="px-4 py-2 bg-red-900/30 text-red-200 rounded hover:bg-red-800/50 transition-colors border border-red-800/50 text-xs opacity-50 hover:opacity-100"
                                        title="強制刷新頁面"
                                    >
                                        強制重置
                                    </button>
                                    <div className="flex gap-4">
                                        <button 
                                            onClick={copyToClipboard}
                                            className="px-4 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors border border-slate-600"
                                        >
                                            複製紀錄
                                        </button>
                                        <button 
                                            onClick={downloadTxt}
                                            className="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-500 transition-colors shadow-lg shadow-amber-900/20"
                                        >
                                            下載 .TXT
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>